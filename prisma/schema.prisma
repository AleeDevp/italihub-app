// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

// Generate tiny, client-safe enum exports for use in client components
generator enum {
  provider = "prisma-generator-enum"
  // Write a single TypeScript module we can import on both server and client
  output   = "../src/generated/enums.ts"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  MODERATOR
  ADMIN
}

model User {
  id            String  @id
  name          String
  email         String
  emailVerified Boolean @default(false)
  image         String? @db.VarChar(512)

  role              UserRole  @default(USER)
  isProfileComplete Boolean @default(false)

  userId String? @unique

  telegramHandle String? @db.VarChar(64)

  cityId Int?
  city   City? @relation(fields: [cityId], references: [id])

  cityLastChangedAt DateTime? // enforce 10-day cooldown in app logic

  verified   Boolean   @default(false)
  verifiedAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now()) @updatedAt
  sessions  Session[]
  accounts  Account[]
  ads       Ad[]
  
  // Verification relations
  verificationRequests    VerificationRequest[] @relation("UserVerifications")
  reviewedVerifications   VerificationRequest[] @relation("VerificationReviewer")
  
  // Moderation relations
  moderationActions       ModerationAction[]
  
  // Reporting relations
  reportedAds             AdReport[]
  
  // Notification relations
  notifications           Notification[]
  
  // Announcement relations
  announcementReads       AnnouncementRead[]
  createdAnnouncements    Announcement[]
  
  // Policy relations
  policyAcceptances       PolicyAcceptance[]

  //indexed so you can quickly find all users in a city
  @@unique([email])
  @@index([cityId])
  @@index([verified])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model City {
  id Int @id @default(autoincrement())

  // Canonical display name (e.g., "Torino")
  name String @db.VarChar(120)

  // URL/lookup key (lowercase, hyphenated, e.g., "torino")
  slug String @unique @db.VarChar(120)

  // Administrative info (optional but useful in Italy)
  region       String? @db.VarChar(120) // e.g., "Piemonte"
  province     String? @db.VarChar(120) // e.g., "Torino"
  provinceCode String? @db.VarChar(4) // e.g., "TO"

  // Map support (optional)
  lat Decimal? @db.Decimal(9, 6)
  lng Decimal? @db.Decimal(9, 6)

  // Alternate names / spellings (e.g., "Turin")
  altNames String[] @default([])

  // Operational controls
  isActive  Boolean @default(true)
  sortOrder Int? // optional manual ordering for UI lists

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User[]
  ads       Ad[]
  verificationRequests VerificationRequest[]
  announcements Announcement[]

  @@index([name])
  @@index([region])
  @@index([provinceCode])
  @@map("cities")
}

// ===== Enums =====
enum AdCategory {
  HOUSING
  TRANSPORTATION
  MARKETPLACE
  CURRENCY
  SERVICES
}

enum AdStatus {
  PENDING
  ONLINE
  REJECTED
  EXPIRED
}

enum MarketplaceCondition {
  NEW
  LIKE_NEW
  USED
  HANDMADE
}

enum MediaRole {
  GALLERY   // default gallery image(s)
  POSTER    // e.g., Services poster
}

enum MediaKind {
  IMAGE
}

// ===== Housing Enums =====
enum HousingRentalKind {
  TEMPORARY
  PERMANENT
}

enum HousingUnitType {
  WHOLE_APARTMENT
  ROOM
  BED
}

enum HousingPropertyType {
  STUDIO
  BILOCALE
  TRILOCALE
  QUADRILOCALE
  OTHER
}

enum HousingRoomType {
  SINGLE
  DOUBLE
  TRIPLE
}

enum HousingContractType {
  NONE
  SHORT_TERM
  LONG_TERM
}

enum HousingPriceType {
  MONTHLY
  DAILY
}

enum BillsPolicy {
  INCLUDED
  EXCLUDED
  PARTIAL
}

enum HouseholdGender {
  MIXED
  FEMALE_ONLY
  MALE_ONLY
  UNKNOWN
}

enum GenderPreference {
  ANY
  FEMALE_ONLY
  MALE_ONLY
}

enum HeatingType {
  CENTRAL
  INDEPENDENT
  NONE
  UNKNOWN
}

// ===== Transportation Enums =====
enum TransportDirection {
  ITALY_TO_IRAN
  IRAN_TO_ITALY
}

enum Country {
  ITALY
  IRAN
}

enum TransportPriceMode {
  NEGOTIABLE
  PER_KG
  FIXED_TOTAL
}

// ===== Services Enums =====
enum ServiceCategory {
  COOKING
  REPAIRS
  CLEANING
  TUTORING
  TRANSLATION
  BEAUTY
  IT_HELP
  MOVING
  DELIVERY
  OTHER
}

enum ServiceRateBasis {
  HOURLY
  FIXED
  PER_TASK
}

enum Weekday {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

// ===== Exchange Enums =====
enum ExchangeSide {
  BUY_EUR
  SELL_EUR
}

enum ExchangeRateType {
  MARKET
  CUSTOM
  NEGOTIABLE
}

enum ExchangeMode {
  IN_PERSON
  ONLINE
  EITHER
}

enum SettlementMethod {
  REVOLUT
  PAYPAL
  BONIFICO_SEPA
  CASH_IN_PERSON
  OTHER
}

// ===== Verification Enums =====
enum VerificationMethod {
  LANDMARK_SELFIE    // selfie with recognizable city landmark
  STUDENT_CARD
  IDENTITA
  PERMESSO
  RENTAL_CONTRACT
  OTHER
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VerificationFileRole {
  IMAGE
  DOCUMENT
  OTHER
}

enum VerificationRejectionCode {
  INSUFFICIENT_PROOF
  CITY_MISMATCH
  EXPIRED_DOCUMENT
  UNREADABLE
  OTHER
}

// ===== Moderation Enums =====
enum ModerationTargetType {
  AD
  VERIFICATION
  REPORT
}

enum ModerationActionType {
  APPROVE
  REJECT
  EXPIRE
  RESTORE
  REQUEST_CHANGES
  EDIT_NOTE
  FLAG
  UNFLAG
  CLOSE          // e.g., close a verification/report ticket
  DISMISS        // e.g., dismiss a report as no-action
}

enum ModerationReasonCode {
  OFF_TOPIC
  WRONG_CATEGORY
  INCOMPLETE_DETAILS
  SPAM
  SCAM_FRAUD
  PROHIBITED_ITEM
  DUPLICATE
  EXPIRED
  OTHER
}

// ===== Reporting Enums =====
enum ReportStatus {
  OPEN
  CLOSED
}

enum ReportReason {
  SCAM_FRAUD
  WRONG_CATEGORY
  OFFENSIVE_CONTENT
  PROHIBITED_ITEM
  DUPLICATE
  MISLEADING
  SPAM
  OTHER
}

enum ReportOutcome {
  NO_ACTION
  AD_REMOVED
  AD_EDITED
  USER_WARNED
  OTHER
}

// ===== Notification Enums =====
enum NotificationType {
  AD_EVENT              // e.g., approved/rejected/pending/expired
  VERIFICATION_EVENT    // e.g., approved/rejected/needs-more-info
  REPORT_EVENT          // e.g., your report was closed/dismissed
  SYSTEM_ANNOUNCEMENT   // maintenance, policy updates, etc.
}

enum NotificationSeverity {
  INFO
  SUCCESS
  WARNING
  ERROR
}

// ===== Announcement Enums =====
enum AnnouncementScope {
  GLOBAL   // shown to all users
  CITY     // shown only to users in a specific city
}

enum AnnouncementAudience {
  ALL_USERS
  VERIFIED_ONLY
  MODS_ADMINS
}

enum AnnouncementSeverity {
  INFO
  SUCCESS
  WARNING
  ERROR
}

// ===== ads =====
model Ad {
  id                  Int        @id @default(autoincrement())
  userId              String
  user                User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  cityId              Int
  city                City       @relation(fields: [cityId], references: [id])
  category            AdCategory
  status              AdStatus   @default(PENDING)
  expirationDate      DateTime?
  viewsCount          Int        @default(0)
  contactClicksCount  Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Gallery relation (many images)
  mediaAssets         MediaAsset[]  @relation("AdImages")

  // O(1) cover pointer for list/SEO cards
  coverMediaId        Int?
  coverMedia          MediaAsset?   @relation("AdCover", fields: [coverMediaId], references: [id])

  // Optional denormalized count (maintain in app code)
  mediaCount          Int           @default(0)

  // children relation "back-relations" (just one of them have value)
  housing             AdHousing?        // 1:1 from ad_housing
  transportation      AdTransportation? // 1:1 from ad_transportation
  marketplace         AdMarketplace?    // 1:1 from ad_marketplace
  service             AdService?        // 1:1 from ad_service
  exchange            AdExchange?       // 1:1 from ad_exchange
  
  // Moderation and reporting relations
  reports             AdReport[]
  moderationActions   ModerationAction[]
  
  // Notification and policy relations
  notifications       Notification[]
  policyAcceptances   PolicyAcceptance[]

  // AdMetricsDaily relation
  metricsDaily        AdMetricsDaily[]

  @@map("ads")
  @@index([cityId, category, status, createdAt])
  @@index([expirationDate])
  @@index([userId, createdAt])
}

model MediaAsset {
  id          Int       @id @default(autoincrement())

  // Gallery relationship
  adId        Int
  ad          Ad        @relation("AdImages", fields: [adId], references: [id], onDelete: Cascade)

  kind        MediaKind @default(IMAGE)
  role        MediaRole @default(GALLERY)

  // Provider-agnostic key (e.g., "ads/123/abc.jpg"); build CDN URL at runtime
  storageKey  String    @db.VarChar(512)
  mimeType    String?   @db.VarChar(100)
  checksum    String?   @db.VarChar(64)

  alt         String?
  order       Int       @default(0)

  // Optional metadata
  width       Int?
  height      Int?
  bytes       Int?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Cover relation (reverse)
  adsCover    Ad[]      @relation("AdCover")

  @@map("media_assets")
  @@index([adId])
  @@index([role, adId, order])
  @@unique([adId, order]) // stable per-ad ordering
  @@unique([storageKey])  // avoid duplicates
}

// ===== Ad Housing =====
model AdHousing {
  // Core
  adId                   Int     @id
  ad                     Ad      @relation(fields: [adId], references: [id], onDelete: Cascade)

  // Rental & Unit
  rentalKind             HousingRentalKind
  unitType               HousingUnitType
  propertyType           HousingPropertyType?

  // Room specifics
  roomType               HousingRoomType?
  roomBedsTotal          Int?
  roomBedsAvailable      Int?

  // Availability & contract
  availabilityStartDate  DateTime
  availabilityEndDate    DateTime?
  contractType           HousingContractType
  residenzaAvailable     Boolean

  // Pricing
  priceType              HousingPriceType
  priceAmount            Decimal?    @db.Decimal(10, 2)
  priceNegotiable        Boolean
  depositAmount          Decimal?    @db.Decimal(10, 2)
  agencyFeeAmount        Decimal?    @db.Decimal(10, 2)

  // Bills
  billsPolicy            BillsPolicy
  billsMonthlyEstimate   Decimal?    @db.Decimal(10, 2)
  billsNotes             String?

  // Property features
  furnished              Boolean
  floorNumber            Int?
  hasElevator            Boolean
  privateBathroom        Boolean
  kitchenEquipped        Boolean
  wifi                   Boolean
  washingMachine         Boolean
  dishwasher             Boolean
  balcony                Boolean
  terrace                Boolean
  heatingType            HeatingType
  doubleGlazedWindows    Boolean
  airConditioning        Boolean

  // Household
  householdSize          Int
  householdGender        HouseholdGender
  genderPreference       GenderPreference
  householdDescription   String?

  // Location
  neighborhood           String?
  streetHint             String?
  lat                    Decimal?    @db.Decimal(9, 6)
  lng                    Decimal?    @db.Decimal(9, 6)
  transitLines           String[]
  shopsNearby            String[]

  // Misc
  notes                  String?

  @@map("ad_housing")
  @@index([priceAmount])
  @@index([availabilityStartDate])
}

// ===== Ad Transportation =====
model AdTransportation {
  // Core
  adId                   Int     @id
  ad                     Ad      @relation(fields: [adId], references: [id], onDelete: Cascade)

  // Route
  direction              TransportDirection
  departureCity          String
  departureCountry       Country
  arrivalCity            String
  arrivalCountry         Country
  additionalPickupCities String[]
  additionalDeliveryCities String[]
  routeNotes             String?

  // Flight & Logistics
  flightDate             DateTime
  capacityKg             Decimal?    @db.Decimal(6, 2)
  minAcceptKg            Int?
  subjectToInspection    Boolean
  documentsAccepted      Boolean
  acceptedItemTypes      String[]
  restrictedItemTypes    String[]
  specialCapacityNotes   String?
  offersPostalForwarding Boolean
  acceptsPostalDropoff   Boolean
  postalNotes            String?
  deliveryEtaDays        Int?

  // Pricing
  priceMode              TransportPriceMode
  pricePerKg             Decimal?    @db.Decimal(10, 2)
  fixedTotalPrice        Decimal?    @db.Decimal(10, 2)
  priceNotes             String?

  // Misc
  termsNotes             String?

  @@map("ad_transportation")
  @@index([flightDate])
  @@index([departureCountry, arrivalCountry, flightDate])
  @@index([departureCity, arrivalCity])
}

// ===== Ad Marketplace =====
model AdMarketplace {
  adId        Int     @id
  ad          Ad      @relation(fields: [adId], references: [id], onDelete: Cascade)

  title       String  @db.VarChar(255)
  description String  @db.VarChar(2000)

  price       Decimal @db.Decimal(10, 2) // allow 0.00 for "negotiable"
  condition   MarketplaceCondition
  category    String? // e.g., "electronics", "food", "clothing", "vehicles", "home_goods"

  @@map("ad_marketplace")
  @@index([price])
  @@index([category])
}

// ===== Ad Service =====
model AdService {
  // Core
  adId                 Int     @id
  ad                   Ad      @relation(fields: [adId], references: [id], onDelete: Cascade)

  // Content
  title                String  @db.VarChar(255)
  description          String  @db.VarChar(2000)

  // Classification
  serviceCategory      ServiceCategory
  tags                 String[] @default([])

  // Pricing
  rateBasis            ServiceRateBasis
  rateAmount           Decimal? @db.Decimal(10, 2) // null if not provided

  // Availability & Area
  availabilityDays     Weekday[] @default([])
  serviceArea          String?

  // Presentation
  businessName         String?
  portfolioLinks       String[] @default([])

  @@map("ad_service")
  @@index([serviceCategory])
  @@index([rateBasis, rateAmount])
}

// ===== Ad Exchange =====
model AdExchange {
  // Core
  adId                 Int     @id
  ad                   Ad      @relation(fields: [adId], references: [id], onDelete: Cascade)

  // Offer
  side                 ExchangeSide
  amountEur            Decimal  @db.Decimal(14, 2)
  allowsPartial        Boolean  @default(true)
  minChunkEur          Decimal? @db.Decimal(14, 2)

  // Rate
  rateType             ExchangeRateType
  rateValue            Decimal? @db.Decimal(18, 4) // required when CUSTOM

  // Settlement
  exchangeMode         ExchangeMode
  settlementMethods    SettlementMethod[]
  otherSettlementNote  String?

  // Meta
  notes                String?

  @@map("ad_exchange")
  @@index([side])
  @@index([amountEur])
}

// ===== Verification Request =====
model VerificationRequest {
  id                 Int                  @id @default(autoincrement())

  userId             String
  user               User                 @relation("UserVerifications", fields: [userId], references: [id], onDelete: Cascade)
  cityId             Int
  city               City                 @relation(fields: [cityId], references: [id])

  method             VerificationMethod
  status             VerificationStatus   @default(PENDING)

  // Timestamps
  submittedAt        DateTime             @default(now())
  reviewedAt         DateTime?

  // Reviewer (moderator/admin)
  reviewedByUserId   String?
  reviewedBy         User?                @relation("VerificationReviewer", fields: [reviewedByUserId], references: [id])

  // Free-form user note (optional context)
  userNote           String?

  // Reviewer/canned reasons on rejection (optional)
  rejectionCode      VerificationRejectionCode?
  rejectionNote      String?

  // Attachments (PRIVATE storage)
  files              VerificationFile[]

  // Moderation relation
  moderationActions  ModerationAction[]
  
  // Notification relation
  notifications      Notification[]

  // Bookkeeping
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  @@map("verification_requests")
  @@index([userId, status])
  @@index([cityId, status])
  @@index([status, submittedAt])
}

model VerificationFile {
  id               Int                   @id @default(autoincrement())

  verificationId   Int
  verification     VerificationRequest   @relation(fields: [verificationId], references: [id], onDelete: Cascade)

  role             VerificationFileRole  @default(DOCUMENT)

  // Private object storage (derive signed URL server-side)
  storageKey       String                @db.VarChar(512)
  mimeType         String?               @db.VarChar(100)
  bytes            Int?

  createdAt        DateTime              @default(now())

  @@map("verification_files")
  @@index([verificationId])
  @@unique([storageKey]) // prevent duplicate uploads referencing same key
}

// ===== Moderation Action =====
model ModerationAction {
  id               Int                     @id @default(autoincrement())

  // Actor
  actorUserId      String
  actor            User                    @relation(fields: [actorUserId], references: [id], onDelete: Cascade)

  // Targets (exactly one must be set)
  adId             Int?
  ad               Ad?                     @relation(fields: [adId], references: [id], onDelete: SetNull)

  verificationId   Int?
  verification     VerificationRequest?    @relation(fields: [verificationId], references: [id], onDelete: SetNull)

  reportId         Int?
  report           AdReport?               @relation(fields: [reportId], references: [id], onDelete: SetNull)

  targetType       ModerationTargetType

  // Decision
  action           ModerationActionType
  reasonCode       ModerationReasonCode?
  reasonText       String?                 // free-text note (user-visible or internal per policy)

  // Optional status snapshot (string to stay generic across targets)
  prevStatus       String?
  nextStatus       String?

  createdAt        DateTime                @default(now())

  @@map("moderation_actions")
  @@index([actorUserId, createdAt])
  @@index([targetType, createdAt])
  @@index([adId])
  @@index([verificationId])
  @@index([reportId])
}

// ===== Ad Report =====
model AdReport {
  id               Int           @id @default(autoincrement())

  // What is being reported
  adId             Int
  ad               Ad            @relation(fields: [adId], references: [id], onDelete: Cascade)

  // Who reported (nullable to allow anonymous/unauthenticated reports if you choose)
  reporterUserId   String?
  reporter         User?         @relation(fields: [reporterUserId], references: [id])

  // Why
  reason           ReportReason
  note             String?

  // Lifecycle
  status           ReportStatus  @default(OPEN)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Resolution (set by moderators/admins)
  closedAt         DateTime?
  closedByUserId   String?
  outcome          ReportOutcome?
  resolutionNote   String?

  // Evidence (private files)
  files            ReportFile[]

  // Moderation relation
  moderationActions ModerationAction[]
  
  // Notification relation
  notifications     Notification[]

  @@map("ad_reports")
  @@index([adId, status, createdAt])
  @@index([reporterUserId, createdAt])
}

model ReportFile {
  id           Int        @id @default(autoincrement())

  reportId     Int
  report       AdReport   @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // Private storage key; derive signed URL server-side
  storageKey   String     @db.VarChar(512)
  mimeType     String?    @db.VarChar(100)
  bytes        Int?

  createdAt    DateTime   @default(now())

  @@map("report_files")
  @@index([reportId])
  @@unique([storageKey])
}

// ===== Notification =====
model Notification {
  id               Int                  @id @default(autoincrement())

  // Recipient
  userId           String
  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Classification
  type             NotificationType
  severity         NotificationSeverity  @default(INFO)

  // Content
  title            String               @db.VarChar(140)
  body             String               @db.VarChar(1000)

  // Optional deep links to context
  adId             Int?
  ad               Ad?                  @relation(fields: [adId], references: [id], onDelete: SetNull)

  verificationId   Int?
  verification     VerificationRequest? @relation(fields: [verificationId], references: [id], onDelete: SetNull)

  reportId         Int?
  report           AdReport?            @relation(fields: [reportId], references: [id], onDelete: SetNull)

  // Optional route or URL for front-end to navigate
  deepLink         String?              @db.VarChar(255)

  // Extra payload for client rendering (optional)
  data             Json?

  // Read state
  readAt           DateTime?

  // Timestamps
  createdAt        DateTime             @default(now())

  @@map("notifications")
  @@index([userId, readAt, createdAt])   // fast unread + recent sorting
  @@index([adId])
  @@index([verificationId])
  @@index([reportId])
}

// ===== Announcement =====
model Announcement {
  id              Int                  @id @default(autoincrement())

  title           String               @db.VarChar(140)
  body            String               @db.VarChar(2000)

  severity        AnnouncementSeverity @default(INFO)

  scope           AnnouncementScope
  cityId          Int?                 // required when scope = CITY
  city            City?                @relation(fields: [cityId], references: [id])

  audience        AnnouncementAudience @default(ALL_USERS)

  // Visibility window & flags
  startsAt        DateTime             @default(now())
  endsAt          DateTime?
  isActive        Boolean              @default(true)
  pinned          Boolean              @default(false)   // show at top
  dismissible     Boolean              @default(true)

  // Optional deep link or route
  deepLink        String?              @db.VarChar(255)
  data            Json?

  // Admin/mod provenance
  createdByUserId String
  createdBy       User                 @relation(fields: [createdByUserId], references: [id])
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Reads
  reads           AnnouncementRead[]

  @@map("announcements")
  @@index([isActive, startsAt, endsAt])
  @@index([scope, cityId])
  @@index([pinned])
}

model AnnouncementRead {
  id              Int          @id @default(autoincrement())

  announcementId  Int
  announcement    Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  readAt          DateTime?
  dismissedAt     DateTime?
  createdAt       DateTime     @default(now())

  @@map("announcement_reads")
  @@unique([announcementId, userId]) // one row per user per announcement
  @@index([userId, readAt, dismissedAt])
}

// ===== Posting Policy =====
model PostingPolicy {
  id            Int        @id @default(autoincrement())

  // Scope of the rules (per category; i18n-ready with locale)
  category      AdCategory
  locale        String     @db.VarChar(8) @default("en") // e.g., "en"

  // Versioning & content
  version       Int
  contentUrl    String?    @db.VarChar(255) // optional public URL to rules page/section
  contentHash   String?    @db.VarChar(64)  // e.g., SHA-256 of the content snapshot

  // Lifecycle
  isActive      Boolean    @default(true)
  effectiveFrom DateTime   @default(now())
  retiredAt     DateTime?

  // Audit
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  acceptances   PolicyAcceptance[]

  @@map("posting_policies")
  @@unique([category, locale, version]) // one version per category/locale
  @@index([isActive, effectiveFrom])
}

model PolicyAcceptance {
  id            Int            @id @default(autoincrement())

  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  policyId      Int
  policy        PostingPolicy  @relation(fields: [policyId], references: [id], onDelete: Cascade)

  // Snapshot (optional, but handy for audits/exports)
  acceptedAt    DateTime       @default(now())
  ip            String?        @db.VarChar(45)
  userAgent     String?        @db.VarChar(255)

  // Optional link to the ad being posted when accepted (useful for traceability)
  adId          Int?
  ad            Ad?            @relation(fields: [adId], references: [id], onDelete: SetNull)

  @@map("policy_acceptances")
  @@unique([userId, policyId])     // user accepts a given version once
  @@index([userId, acceptedAt])
}




model AdMetricsDaily {
  // Composite PK: one row per ad per calendar day (Europe/Rome)
  adId          Int
  date          DateTime   // bucketed to 00:00:00 in Europe/Rome

  views         Int        @default(0)
  contactClicks Int        @default(0)

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  ad            Ad         @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@id([adId, date])
  @@map("ad_metrics_daily")
  @@index([date]) // fast range queries across many ads
}


enum AuditOutcome {
  SUCCESS
  FAILURE
}

enum AuditActorRole {
  USER
  VERIFIED_USER
  MODERATOR
  ADMIN
  SYSTEM
}

enum AuditEntityType {
  // Ads (parent + per-category)
  AD
  AD_HOUSING
  AD_TRANSPORTATION
  AD_MARKETPLACE
  AD_SERVICE
  AD_EXCHANGE

  // Identity & moderation-related
  USER
  MODERATION_ACTION

  // Verification
  VERIFICATION_REQUEST
  VERIFICATION_FILE

  // Reports
  AD_REPORT
  REPORT_FILE

  // Messaging / broadcast
  ANNOUNCEMENT
  NOTIFICATION

  // Policies & consent (tables exist)
  POSTING_POLICY
  POLICY_ACCEPTANCE

  // Media & system
  MEDIA_ASSET
  CITY
  OTHER
}

// ✅ All mutation/decision points worth logging (stable uppercase snake-case)
enum AuditAction {
  // Auth & account
  REGISTER
  LOGIN
  LOGOUT
  PASSWORD_RESET_REQUEST
  PASSWORD_RESET_CONFIRM
  PASSWORD_CHANGE
  EMAIL_CHANGE_REQUEST
  EMAIL_CHANGE_CONFIRM
  OAUTH_LINK_GOOGLE
  OAUTH_UNLINK_GOOGLE
  OAUTH_LINK_FACEBOOK
  OAUTH_UNLINK_FACEBOOK
  SESSION_REVOKE_ALL
  ACCOUNT_DELETE_REQUEST
  ACCOUNT_DELETE

  // Profile
  PROFILE_COMPLETE
  PROFILE_EDIT
  PROFILE_NAME_EDIT
  PROFILE_USERID_EDIT
  PROFILE_TELEGRAMID_EDIT
  PROFILE_PHOTO_CHANGE
  PROFILE_PHOTO_DELETE
  CITY_CHANGE
  ROLE_ASSIGN
  ROLE_REVOKE

  // Verification (sensitive)
  VERIFICATION_SUBMIT
  VERIFICATION_FILE_UPLOAD
  VERIFICATION_FILE_DELETE
  VERIFICATION_APPROVE
  VERIFICATION_REJECT
  VERIFICATION_REVOKE
  VERIFICATION_ACCESS // moderator/system viewed private docs

  // Ads — owner actions
  AD_CREATE
  AD_EDIT
  AD_RENEW
  AD_DELETE
  AD_SUBMIT_FOR_REVIEW
  AD_MEDIA_UPLOAD
  AD_MEDIA_DELETE
  AD_MEDIA_REORDER
  AD_COVER_SET
  AD_CONTACT_REVEAL

  // Ads — moderation/status
  AD_APPROVE
  AD_REJECT
  AD_EXPIRE
  AD_RESTORE
  AD_STATUS_SET

  // Reports
  REPORT_SUBMIT
  REPORT_FILE_UPLOAD
  REPORT_FILE_DELETE
  REPORT_FLAG
  REPORT_UNFLAG
  REPORT_CLOSE
  REPORT_DISMISS

  // Notifications & announcements
  NOTIFICATION_CREATE
  NOTIFICATION_MARK_READ
  NOTIFICATION_MARK_ALL_READ
  ANNOUNCEMENT_CREATE
  ANNOUNCEMENT_UPDATE
  ANNOUNCEMENT_DELETE
  ANNOUNCEMENT_PIN
  ANNOUNCEMENT_UNPIN
  ANNOUNCEMENT_DISMISS

  // Policies (lifecycle + consent)
  POLICY_CREATE
  POLICY_UPDATE
  POLICY_RETIRE
  POLICY_ACCEPT

  // Cities (admin)
  CITY_CREATE
  CITY_UPDATE
  CITY_ENABLE
  CITY_DISABLE
  CITY_SORT_UPDATE

  // Email & support
  EMAIL_SEND
  SUPPORT_MESSAGE_SEND

  // System jobs & maintenance
  SCHEDULER_EXPIRE_ADS
  METRICS_ROLLUP
  CLEANUP_ORPHAN_MEDIA
  MIGRATION_RUN
  BATCH_CLEANUP
}

model AuditLog {
  id              Int             @id @default(autoincrement())

  // WHO
  actorUserId     String?         // null when SYSTEM or unauthenticated
  actorRole       AuditActorRole? // snapshot of role at action time

  // WHAT
  action          AuditAction         
  outcome         AuditOutcome
  errorCode       String?         @db.VarChar(64)   // optional short code on FAILURE

  // WHICH RESOURCE
  entityType      AuditEntityType
  entityId        Int?                                // e.g., adId, verificationId, etc.

  // CONTEXT
  requestId       String?         @db.VarChar(64)    // correlation id for a single HTTP request
  sessionId       String?         @db.VarChar(64)
  ip              String?         @db.VarChar(45)    // IPv4/IPv6
  userAgent       String?         @db.VarChar(512)

  // DETAILS (sanitized)
  metadata        Json?           // e.g., { "diff": {...}, "payload": {...} } (NO secrets/PII)
  note            String?         // optional human note

  createdAt       DateTime        @default(now())

  @@map("audit_logs")
  @@index([createdAt])
  @@index([actorUserId, createdAt])
  @@index([entityType, entityId, createdAt])
  @@index([action, createdAt])
  @@index([requestId])
}
