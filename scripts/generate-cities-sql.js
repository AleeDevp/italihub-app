/*
Generates SQL to seed the `cities` table based on `src/constants/italianCities.ts`.
Uses the fields provided in the TS file (slug, region, province, provinceCode, lat, lng, altNames, isActive, sortOrder).
Outputs: prisma/seed/insert_cities.sql and (optionally) executes it against the DB.

Env options:
  LIMIT=<n>      Limit number of rows for quick tests
  EXECUTE=true   Execute the generated SQL via `prisma db execute`
*/

const fs = require('fs');
const path = require('path');
const child_process = require('child_process');

const INPUT_TS = path.join(__dirname, '..', 'src', 'constants', 'italianCities.ts');
const OUT_SQL = path.join(__dirname, '..', 'prisma', 'seed', 'insert_cities.sql');
// no cache needed; we now rely on static data in TS file

function readItalianCities() {
  let content = fs.readFileSync(INPUT_TS, 'utf8');
  // Transform to a CommonJS export we can require via eval in a sandboxed Function
  // Replace `export const italianCities:` with `module.exports =` and drop the type annotation.
  content = content.replace(/export\s+const\s+italianCities\s*:[^=]*=/, 'module.exports =');
  // Now evaluate in an isolated function scope to produce the array
  const loader = new Function('module', 'exports', content + '\n;return module.exports;');
  const moduleObj = { exports: {} };
  const result = loader(moduleObj, moduleObj.exports);
  if (!Array.isArray(result)) {
    throw new Error('Parsed italianCities is not an array.');
  }
  return result;
}

function slugify(name) {
  return name
    .toLowerCase()
    .normalize('NFD')
    .replace(/\p{Diacritic}+/gu, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
}

// No network enrichment; using TS-provided fields

function escSql(val) {
  if (val === null || val === undefined) return 'NULL';
  return `'${String(val).replace(/'/g, "''")}'`;
}

function numOrNull(n, digits = null) {
  if (n === null || n === undefined || Number.isNaN(n)) return 'NULL';
  const num = Number(n);
  return digits ? num.toFixed(digits) : String(num);
}

async function main() {
  const cities = readItalianCities();
  const values = [];
  const limit = process.env.LIMIT ? Number(process.env.LIMIT) : null;

  let count = 0;
  for (const c of cities) {
    if (limit && count >= limit) break;
    const name = c.name;
    const slug = c.slug || slugify(name);
    const region = c.region ?? null;
    const province = c.province ?? null;
    const provinceCode = c.provinceCode ?? null;
    const lat = c.lat != null ? Number(c.lat) : null;
    const lng = c.lng != null ? Number(c.lng) : null;
    const altNames = Array.isArray(c.altNames) ? c.altNames : [];
    const isActive = typeof c.isActive === 'boolean' ? c.isActive : true;
    const sortOrder = c.sortOrder ?? c.id ?? null;

    values.push(
      `(${escSql(name)}, ${escSql(slug)}, ${escSql(region)}, ${escSql(province)}, ${escSql(provinceCode)}, ${numOrNull(lat, 6)}, ${numOrNull(lng, 6)}, ${altNames.length ? `ARRAY[${altNames.map(escSql).join(', ')}]::TEXT[]` : 'ARRAY[]::TEXT[]'}, ${isActive ? 'true' : 'false'}, ${sortOrder == null ? 'NULL' : sortOrder}, CURRENT_TIMESTAMP)`
    );
    count++;
  }

  const sql = `-- Auto-generated by scripts/generate-cities-sql.js\n-- Inserts or upserts cities into public.cities table\n\nINSERT INTO public.cities (name, slug, region, province, "provinceCode", lat, lng, "altNames", "isActive", "sortOrder", "updatedAt")\nVALUES\n${values.map((v) => `  ${v}`).join(',\n')}\nON CONFLICT (slug) DO UPDATE SET\n  name = EXCLUDED.name,\n  region = EXCLUDED.region,\n  province = EXCLUDED.province,\n  "provinceCode" = EXCLUDED."provinceCode",\n  lat = EXCLUDED.lat,\n  lng = EXCLUDED.lng,\n  "altNames" = EXCLUDED."altNames",\n  "isActive" = EXCLUDED."isActive",\n  "sortOrder" = EXCLUDED."sortOrder",\n  "updatedAt" = CURRENT_TIMESTAMP;\n`;

  fs.writeFileSync(OUT_SQL, sql);
  console.log('Wrote', OUT_SQL);

  if (String(process.env.EXECUTE).toLowerCase() === 'true') {
    console.log('Executing SQL via prisma db execute...');
    try {
      child_process.execSync(
        'npx prisma db execute --file=prisma/seed/insert_cities.sql --schema=prisma/schema.prisma',
        {
          stdio: 'inherit',
        }
      );
      console.log('SQL execution completed.');
    } catch (e) {
      console.error('Failed to execute SQL:', e.message);
      process.exitCode = 1;
    }
  }
}

main().catch((e) => {
  console.error(e);
  process.exit(1);
});
